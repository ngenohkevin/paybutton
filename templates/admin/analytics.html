{{define "content"}}
<div class="analytics-dashboard animate-fade-in">
    <!-- Analytics Header -->
    <div class="dashboard-header mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                    <i class="fas fa-chart-line mr-3 text-blue-600"></i>Analytics & Metrics
                </h1>
                <p class="text-gray-600 dark:text-gray-400 mt-2">
                    Real-time performance insights and historical data analysis
                </p>
            </div>
            <div class="flex flex-wrap gap-3">
                <select id="timePeriodSelect" class="filter-control bg-white dark:bg-gray-800">
                    <option value="1h">Last Hour</option>
                    <option value="6h">Last 6 Hours</option>
                    <option value="24h" selected>Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                </select>
                <button onclick="refreshAnalytics()" class="btn btn-primary">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
                <button onclick="exportAnalytics()" class="btn btn-secondary">
                    <i class="fas fa-download mr-2"></i>Export
                </button>
            </div>
        </div>
    </div>

    <!-- Site Analytics KPI Cards -->
    <div class="kpi-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        <!-- Total Active Users KPI -->
        <div class="kpi-card card hover:scale-105 transition-transform">
            <div class="card-body text-center">
                <div class="kpi-icon mb-4">
                    <i class="fas fa-users text-4xl text-blue-500"></i>
                </div>
                <div class="kpi-value text-3xl font-bold text-blue-600 dark:text-blue-400 mb-2" id="totalActiveValue">
                    0
                </div>
                <div class="kpi-label text-sm text-gray-600 dark:text-gray-400 font-medium">
                    Active Viewers
                </div>
                <div class="kpi-change text-xs text-blue-600 mt-2" id="activeChange">
                    <i class="fas fa-circle mr-1 animate-pulse"></i>Live Updates
                </div>
            </div>
        </div>

        <!-- Total Weekly Visitors KPI -->
        <div class="kpi-card card hover:scale-105 transition-transform">
            <div class="card-body text-center">
                <div class="kpi-icon mb-4">
                    <i class="fas fa-chart-bar text-4xl text-emerald-500"></i>
                </div>
                <div class="kpi-value text-3xl font-bold text-emerald-600 dark:text-emerald-400 mb-2" id="totalWeeklyValue">
                    0
                </div>
                <div class="kpi-label text-sm text-gray-600 dark:text-gray-400 font-medium">
                    Weekly Visitors
                </div>
                <div class="kpi-change text-xs text-emerald-600 mt-2" id="weeklyChange">
                    <i class="fas fa-calendar-week mr-1"></i>7 Day Total
                </div>
            </div>
        </div>

        <!-- Active Sites Count KPI -->
        <div class="kpi-card card hover:scale-105 transition-transform">
            <div class="card-body text-center">
                <div class="kpi-icon mb-4">
                    <i class="fas fa-globe text-4xl text-purple-500"></i>
                </div>
                <div class="kpi-value text-3xl font-bold text-purple-600 dark:text-purple-400 mb-2" id="activeSitesValue">
                    0
                </div>
                <div class="kpi-label text-sm text-gray-600 dark:text-gray-400 font-medium">
                    Active Sites
                </div>
                <div class="kpi-change text-xs text-purple-600 mt-2" id="sitesChange">
                    <i class="fas fa-server mr-1"></i>Sites Online
                </div>
            </div>
        </div>
    </div>

    <!-- Phase 5: Historical Data Chart Section -->
    <div class="historical-chart-section mb-8">
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                    <i class="fas fa-chart-area text-indigo-500 mr-3"></i>
                    Historical Viewer Trends (30 Days)
                </h3>
                <div class="chart-controls">
                    <select id="historicalPeriod" class="filter-control bg-white dark:bg-gray-800">
                        <option value="24">Last 24 Hours</option>
                        <option value="168">Last Week</option>
                        <option value="720" selected>Last 30 Days</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container h-80">
                    <canvas id="historicalChart"></canvas>
                </div>
                <div class="chart-stats mt-4 grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                    <div>
                        <div class="text-lg font-bold text-blue-600" id="avgViewersText">0</div>
                        <div class="text-xs text-gray-600">Average Viewers</div>
                    </div>
                    <div>
                        <div class="text-lg font-bold text-green-600" id="peakViewersText">0</div>
                        <div class="text-xs text-gray-600">Peak Viewers</div>
                    </div>
                    <div>
                        <div class="text-lg font-bold text-purple-600" id="trendText">N/A</div>
                        <div class="text-xs text-gray-600">Trend</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Site Analytics Chart Section -->
    <div class="charts-section grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Active Viewers Chart -->
        <div class="chart-card card">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                    <i class="fas fa-chart-line text-blue-500 mr-3"></i>
                    Active Viewers by Site
                </h3>
                <div class="chart-controls">
                    <button class="chart-toggle active" data-chart="doughnut">Doughnut</button>
                    <button class="chart-toggle" data-chart="bar">Bar</button>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container h-64">
                    <canvas id="activeViewersChart"></canvas>
                </div>
                <div class="chart-stats mt-4 text-center">
                    <div class="text-sm text-gray-600 dark:text-gray-400" id="activeStatsText">
                        Real-time active viewer distribution across sites
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Visitors Chart -->
        <div class="chart-card card">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                    <i class="fas fa-chart-bar text-emerald-500 mr-3"></i>
                    Weekly Visitors by Site
                </h3>
                <div class="chart-controls">
                    <button class="chart-toggle active" data-chart="bar">Bar</button>
                    <button class="chart-toggle" data-chart="line">Line</button>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container h-64">
                    <canvas id="weeklyVisitorsChart"></canvas>
                </div>
                <div class="chart-stats mt-4 text-center">
                    <div class="text-sm text-gray-600 dark:text-gray-400" id="weeklyStatsText">
                        7-day visitor totals per site
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Site Analytics Table Section -->
    <div class="table-section mb-8">
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                    <i class="fas fa-table text-gray-500 mr-3"></i>
                    Site Analytics Overview
                </h3>
                <div class="table-controls flex gap-2">
                    <select id="sortBy" class="filter-control bg-white dark:bg-gray-800">
                        <option value="active">Sort by Active</option>
                        <option value="weekly">Sort by Weekly</option>
                        <option value="name">Sort by Name</option>
                    </select>
                    <button onclick="toggleSortOrder()" class="btn btn-secondary" id="sortOrderBtn">
                        <i class="fas fa-sort-amount-down"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="overflow-x-auto">
                    <table class="analytics-table w-full">
                        <thead>
                            <tr>
                                <th class="text-left">Site Name</th>
                                <th class="text-center">Active Now</th>
                                <th class="text-center">Weekly Total</th>
                                <th class="text-center">Last Activity</th>
                                <th class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="siteAnalyticsTableBody">
                            <tr>
                                <td colspan="5" class="text-center text-gray-500 py-8">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>
                                    Loading site analytics data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Phase 5: Advanced Analytics Sections -->
    <div class="advanced-analytics-section grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Popular Pages Section -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                    <i class="fas fa-file-alt text-orange-500 mr-3"></i>
                    Popular Pages
                </h3>
                <div class="controls">
                    <select id="siteFilterPages" class="filter-control bg-white dark:bg-gray-800">
                        <option value="">All Sites</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div id="pagesTableContainer" class="overflow-y-auto max-h-64">
                    <table class="pages-table w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <th class="text-left py-2">Page Path</th>
                                <th class="text-center py-2">Views</th>
                                <th class="text-center py-2">Unique</th>
                            </tr>
                        </thead>
                        <tbody id="pagesTableBody">
                            <tr>
                                <td colspan="3" class="text-center text-gray-500 py-4">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>Loading...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Geographic Regions Section -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                    <i class="fas fa-globe-americas text-teal-500 mr-3"></i>
                    Language Regions
                </h3>
                <div class="controls">
                    <select id="siteFilterRegions" class="filter-control bg-white dark:bg-gray-800">
                        <option value="">All Sites</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div class="regions-container">
                    <div class="chart-container h-32 mb-4">
                        <canvas id="regionsChart"></canvas>
                    </div>
                    <div id="regionsTableContainer" class="overflow-y-auto max-h-32">
                        <table class="regions-table w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200 dark:border-gray-700">
                                    <th class="text-left py-2">Region</th>
                                    <th class="text-center py-2">Count</th>
                                    <th class="text-center py-2">%</th>
                                </tr>
                            </thead>
                            <tbody id="regionsTableBody">
                                <tr>
                                    <td colspan="3" class="text-center text-gray-500 py-4">
                                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Phase 5: Export Section -->
    <div class="export-section mb-8">
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                    <i class="fas fa-download text-green-500 mr-3"></i>
                    Data Export
                </h3>
            </div>
            <div class="card-body">
                <div class="export-controls grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Select Site
                        </label>
                        <select id="exportSiteSelect" class="filter-control bg-white dark:bg-gray-800 w-full">
                            <option value="">Select a site...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Time Period
                        </label>
                        <select id="exportPeriodSelect" class="filter-control bg-white dark:bg-gray-800 w-full">
                            <option value="24h">Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="30d" selected>Last 30 Days</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Format
                        </label>
                        <div class="flex gap-2">
                            <button onclick="exportSiteData('json')" class="btn btn-primary flex-1">
                                <i class="fas fa-code mr-2"></i>JSON
                            </button>
                            <button onclick="exportSiteData('csv')" class="btn btn-secondary flex-1">
                                <i class="fas fa-table mr-2"></i>CSV
                            </button>
                        </div>
                    </div>
                </div>
                <div class="export-status mt-4 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg" id="exportStatus" style="display: none;">
                    <div class="flex items-center">
                        <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                        <span class="text-sm">Export status will appear here...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Updates & Status Section -->
    <div class="status-section grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Live Status Card -->
        <div class="activity-card card">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                    <i class="fas fa-broadcast-tower text-green-500 mr-3"></i>
                    Live Analytics Status
                </h3>
                <div class="activity-status">
                    <span class="flex items-center text-sm text-green-600 dark:text-green-400" id="liveStatus">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                        Connected
                    </span>
                </div>
            </div>
            <div class="card-body">
                <div class="status-grid space-y-4">
                    <div class="status-item flex justify-between items-center">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Update Frequency</span>
                        <span class="text-sm font-medium text-blue-600">5 seconds</span>
                    </div>
                    <div class="status-item flex justify-between items-center">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Data Coverage</span>
                        <span class="text-sm font-medium text-emerald-600">7 days rolling</span>
                    </div>
                    <div class="status-item flex justify-between items-center">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Privacy Mode</span>
                        <span class="text-sm font-medium text-purple-600">Tor-friendly</span>
                    </div>
                    <div class="status-item flex justify-between items-center">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Last Updated</span>
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300" id="lastUpdated">
                            Never
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Summary -->
        <div class="insights-card card">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                    <i class="fas fa-chart-pie text-purple-500 mr-3"></i>
                    Analytics Summary
                </h3>
            </div>
            <div class="card-body">
                <div class="summary-stats space-y-4" id="analyticsSummary">
                    <div class="summary-item">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-500 mb-2">No Data</div>
                            <div class="text-sm text-gray-400">Waiting for site analytics...</div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="text-center">
                        <button onclick="refreshAnalytics()" class="btn btn-primary" id="refreshBtn">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Integration Info -->
    <div class="integration-section">
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                    <i class="fas fa-code text-blue-500 mr-3"></i>
                    Integration Guide
                </h3>
            </div>
            <div class="card-body">
                <div class="integration-info space-y-6">
                    <div class="info-section">
                        <h4 class="text-md font-semibold text-gray-800 dark:text-gray-200 mb-3">
                            <i class="fas fa-globe mr-2 text-green-500"></i>Add Analytics to Your Website
                        </h4>
                        <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4">
                            <code class="text-sm text-gray-700 dark:text-gray-300">
                                &lt;script src="https://your-paybutton-service.com/analytics.js?site=<span class="text-blue-600">your-site-name</span>" async&gt;&lt;/script&gt;
                            </code>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                            Replace <span class="font-mono text-blue-600">your-site-name</span> with your unique site identifier.
                        </p>
                    </div>
                    
                    <div class="info-section">
                        <h4 class="text-md font-semibold text-gray-800 dark:text-gray-200 mb-3">
                            <i class="fas fa-shield-alt mr-2 text-purple-500"></i>Privacy-First Design
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600 dark:text-gray-400">
                            <div class="flex items-center">
                                <i class="fas fa-check text-green-500 mr-2"></i>
                                No IP tracking
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check text-green-500 mr-2"></i>
                                No cookies stored
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check text-green-500 mr-2"></i>
                                Tor network compatible
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check text-green-500 mr-2"></i>
                                Real-time WebSocket updates
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="analyticsLoading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-8 text-center">
        <div class="loading-spinner mx-auto mb-4"></div>
        <p class="text-gray-600 dark:text-gray-400">Loading analytics data...</p>
    </div>
</div>

<style>
/* Analytics-specific styles */
.analytics-dashboard {
    animation: fadeIn 0.6s ease-out;
}

.kpi-card {
    background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    box-shadow: var(--shadow-md);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ef4444, #10b981);
    background-size: 200% 100%;
    animation: gradientShift 3s ease-in-out infinite;
}

@keyframes gradientShift {
    0%, 100% { background-position: 0% 0%; }
    50% { background-position: 100% 0%; }
}

.kpi-icon {
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
}

.kpi-value {
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.chart-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    box-shadow: var(--shadow-lg);
    transition: all 0.3s ease;
}

.chart-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.chart-container {
    position: relative;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
    border-radius: 12px;
    padding: 1rem;
}

.chart-controls {
    display: flex;
    gap: 0.5rem;
}

.chart-toggle {
    padding: 0.375rem 0.75rem;
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.chart-toggle.active {
    background: var(--accent-blue);
    color: white;
    border-color: var(--accent-blue);
}

.chart-toggle:hover:not(.active) {
    background: var(--border-color);
}

.chart-stats {
    background: rgba(255, 255, 255, 0.5);
    border-radius: 12px;
    padding: 1rem;
    backdrop-filter: blur(10px);
}

[data-theme="dark"] .chart-stats {
    background: rgba(0, 0, 0, 0.3);
}

.performance-metric {
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    backdrop-filter: blur(5px);
    transition: all 0.2s ease;
}

.performance-metric:hover {
    background: rgba(255, 255, 255, 0.5);
    transform: translateX(4px);
}

[data-theme="dark"] .performance-metric {
    background: rgba(0, 0, 0, 0.2);
}

[data-theme="dark"] .performance-metric:hover {
    background: rgba(0, 0, 0, 0.3);
}

.activity-feed {
    scrollbar-width: thin;
    scrollbar-color: var(--border-color) transparent;
}

.activity-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    border-left: 4px solid var(--accent-blue);
    transition: all 0.2s ease;
}

.activity-item:hover {
    background: rgba(255, 255, 255, 0.5);
    transform: translateX(4px);
}

[data-theme="dark"] .activity-item {
    background: rgba(0, 0, 0, 0.2);
}

[data-theme="dark"] .activity-item:hover {
    background: rgba(0, 0, 0, 0.3);
}

.insight-item {
    padding: 1rem;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.1) 100%);
    border-radius: 12px;
    border-left: 4px solid var(--accent-yellow);
    transition: all 0.3s ease;
}

.insight-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

[data-theme="dark"] .insight-item {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.1) 100%);
}

.table-tab {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.table-tab.active {
    background: var(--accent-blue);
    color: white;
    border-color: var(--accent-blue);
}

.table-tab:hover:not(.active) {
    background: var(--border-color);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease-out;
}

.analytics-table {
    border-collapse: separate;
    border-spacing: 0;
}

.analytics-table th {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    font-weight: 600;
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 2px solid var(--border-color);
    font-size: 0.875rem;
}

.analytics-table th:first-child {
    border-top-left-radius: 8px;
}

.analytics-table th:last-child {
    border-top-right-radius: 8px;
}

.analytics-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-light);
    font-size: 0.875rem;
    transition: all 0.2s ease;
}

.analytics-table tr:hover td {
    background: var(--bg-tertiary);
}

.analytics-table tr:last-child td:first-child {
    border-bottom-left-radius: 8px;
}

.analytics-table tr:last-child td:last-child {
    border-bottom-right-radius: 8px;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.status-badge.healthy {
    background: rgba(16, 185, 129, 0.1);
    color: var(--accent-green);
}

.status-badge.warning {
    background: rgba(245, 158, 11, 0.1);
    color: var(--accent-yellow);
}

.status-badge.critical {
    background: rgba(239, 68, 68, 0.1);
    color: var(--accent-red);
}

/* Mobile optimizations */
@media (max-width: 768px) {
    .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    
    .charts-section {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .performance-section {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .insights-section {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .chart-container {
        height: 200px !important;
    }
    
    .chart-stats {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .dashboard-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .analytics-table {
        font-size: 0.75rem;
    }
    
    .analytics-table th,
    .analytics-table td {
        padding: 0.5rem;
    }
}

@media (max-width: 480px) {
    .kpi-grid {
        grid-template-columns: 1fr;
    }
    
    .kpi-value {
        font-size: 2rem;
    }
    
    .chart-container {
        height: 180px !important;
        padding: 0.5rem;
    }
    
    .performance-metric {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
    }
    
    .insight-item {
        padding: 0.75rem;
    }
}

/* High contrast mode */
@media (prefers-contrast: high) {
    .kpi-card,
    .chart-card,
    .activity-card,
    .insights-card {
        border-width: 2px;
        border-color: currentColor;
    }
    
    .chart-container {
        border: 1px solid currentColor;
    }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
    .kpi-card::before {
        animation: none;
    }
    
    .analytics-dashboard,
    .tab-content.active {
        animation: none;
    }
    
    .kpi-card,
    .chart-card {
        transition: none;
    }
}
</style>

<script>
// Phase 5: Analytics Dashboard JavaScript with Advanced Features
let analyticsData = {};
let charts = {};
let currentPeriod = '24h';
let refreshInterval = null;
let sitesData = {};

// Initialize analytics dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeAnalytics();
    setupEventListeners();
    startRealTimeUpdates();
});

function initializeAnalytics() {
    initializeCharts();
    loadRealAnalyticsData();
    setupPhase5Features();
}

function setupEventListeners() {
    // Time period selector
    document.getElementById('timePeriodSelect').addEventListener('change', function(e) {
        currentPeriod = e.target.value;
        refreshAnalytics();
    });
    
    // Historical period selector (Phase 5)
    const historicalSelect = document.getElementById('historicalPeriod');
    if (historicalSelect) {
        historicalSelect.addEventListener('change', function(e) {
            updateHistoricalChart(e.target.value);
        });
    }
    
    // Site filters for advanced features (Phase 5)
    const siteFilterPages = document.getElementById('siteFilterPages');
    if (siteFilterPages) {
        siteFilterPages.addEventListener('change', function(e) {
            updatePageStats(e.target.value);
        });
    }
    
    const siteFilterRegions = document.getElementById('siteFilterRegions');
    if (siteFilterRegions) {
        siteFilterRegions.addEventListener('change', function(e) {
            updateRegionStats(e.target.value);
        });
    }
    
    // Chart toggles
    document.querySelectorAll('.chart-toggle').forEach(button => {
        button.addEventListener('click', function() {
            const chartType = this.dataset.chart;
            const container = this.closest('.chart-card');
            
            // Update toggle state
            container.querySelectorAll('.chart-toggle').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Update chart (placeholder for chart type switching)
            console.log('Switching chart type to:', chartType);
        });
    });
    
    // Table tabs
    document.querySelectorAll('.table-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            
            // Update tab state
            document.querySelectorAll('.table-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Show corresponding content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
        });
    });
}

// Real-time updates
function startRealTimeUpdates() {
    refreshInterval = setInterval(() => {
        loadRealAnalyticsData();
        // Update last updated timestamp
        const lastUpdatedEl = document.getElementById('lastUpdated');
        if (lastUpdatedEl) {
            lastUpdatedEl.textContent = new Date().toLocaleString();
        }
    }, 5000); // Update every 5 seconds
}

function loadAnalyticsData() {
    // Simulate loading analytics data
    analyticsData = {
        uptime: 99.9,
        addressGenRate: 8.5,
        paymentSuccessRate: 97.2,
        errorRate: 0.8,
        responseTime: 75,
        memoryUsage: 156,
        cpuUsage: 23,
        insights: [
            "System performance is optimal with 99.9% uptime",
            "Address generation rate increased by 12% in the last hour",
            "Payment success rate improved by 1.5% compared to yesterday",
            "Error rate decreased by 0.3% - system stability improving"
        ]
    };
    
    updateKPIs();
}

function updateKPIs() {
    // These elements don't exist in the current template, skip updating them
    const uptimeEl = document.getElementById('uptimeValue');
    if (uptimeEl) uptimeEl.textContent = analyticsData.uptime + '%';
    
    const addressGenEl = document.getElementById('addressGenValue');
    if (addressGenEl) addressGenEl.textContent = analyticsData.addressGenRate;
    
    const paymentSuccessEl = document.getElementById('paymentSuccessValue');
    if (paymentSuccessEl) paymentSuccessEl.textContent = analyticsData.paymentSuccessRate + '%';
    
    const errorRateEl = document.getElementById('errorRateValue');
    if (errorRateEl) errorRateEl.textContent = analyticsData.errorRate + '%';
    
    const responseTimeEl = document.getElementById('responseTime');
    if (responseTimeEl) responseTimeEl.textContent = analyticsData.responseTime + 'ms';
    
    const memoryUsageEl = document.getElementById('memoryUsage');
    if (memoryUsageEl) memoryUsageEl.textContent = analyticsData.memoryUsage + 'MB';
    
    const cpuUsageEl = document.getElementById('cpuUsage');
    if (cpuUsageEl) cpuUsageEl.textContent = analyticsData.cpuUsage + '%';
}

function initializeCharts() {
    // Active Viewers Chart
    const activeViewersCanvas = document.getElementById('activeViewersChart');
    if (activeViewersCanvas) {
        const ctx = activeViewersCanvas.getContext('2d');
        charts.activeViewers = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [
                        '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6',
                        '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: { size: 11 }
                        }
                    }
                }
            }
        });
    }
    
    // Weekly Visitors Chart
    const weeklyVisitorsCanvas = document.getElementById('weeklyVisitorsChart');
    if (weeklyVisitorsCanvas) {
        const ctx = weeklyVisitorsCanvas.getContext('2d');
        charts.weeklyVisitors = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Weekly Visitors',
                    data: [],
                    backgroundColor: '#3b82f6',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    
    // Historical Chart (Phase 5)
    const historicalCanvas = document.getElementById('historicalChart');
    if (historicalCanvas) {
        const ctx = historicalCanvas.getContext('2d');
        charts.historical = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Viewers',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
}

// Phase 5: Advanced Analytics Functions

function setupPhase5Features() {
    // Initialize historical chart
    if (document.getElementById('historicalChart')) {
        updateHistoricalChart('720'); // 30 days default
    }
    
    // Initialize empty states for advanced features
    updatePageStats('');
    updateRegionStats('');
    
    // Update site dropdowns
    updateSiteDropdowns();
}

function updateSiteDropdowns() {
    const siteNames = Object.keys(analyticsData?.sites || {});
    
    ['exportSiteSelect', 'siteFilterPages', 'siteFilterRegions'].forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;
        
        const currentValue = select.value;
        select.innerHTML = selectId === 'exportSiteSelect' ? 
            '<option value="">Select a site...</option>' :
            '<option value="">All Sites</option>';
            
        siteNames.forEach(siteName => {
            const option = document.createElement('option');
            option.value = siteName;
            option.textContent = siteName;
            select.appendChild(option);
        });
        
        select.value = currentValue;
    });
}

// Historical chart update
function updateHistoricalChart(hours) {
    if (!analyticsData?.sites || Object.keys(analyticsData.sites).length === 0) return;
    
    const siteName = Object.keys(analyticsData.sites)[0];
    fetch(`/admin/api/site-analytics/${siteName}/historical?hours=${hours}`)
        .then(response => response.json())
        .then(data => {
            const canvas = document.getElementById('historicalChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            if (charts.historical) {
                charts.historical.destroy();
            }
            
            const labels = data.historical_data?.map(point => 
                new Date(point.timestamp).toLocaleTimeString()
            ) || [];
            const values = data.historical_data?.map(point => point.viewers) || [];
            
            charts.historical = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Active Viewers',
                        data: values,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
            
            // Update stats
            if (values.length > 0) {
                const avg = Math.round(values.reduce((a, b) => a + b, 0) / values.length);
                const max = Math.max(...values);
                document.getElementById('avgViewersText').textContent = avg;
                document.getElementById('peakViewersText').textContent = max;
                document.getElementById('trendText').textContent = 
                    values[values.length - 1] > values[0] ? '↗ Rising' : '↘ Declining';
            }
        })
        .catch(error => console.error('Historical chart error:', error));
}

// Page statistics
function updatePageStats(siteName) {
    const tbody = document.getElementById('pagesTableBody');
    if (!tbody) return;
    
    if (!siteName) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-4">Select a site to view page statistics</td></tr>';
        return;
    }
    
    fetch(`/admin/api/site-analytics/${siteName}/pages?limit=10`)
        .then(response => response.json())
        .then(data => {
            if (!data.page_stats || data.page_stats.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-4">No page data available</td></tr>';
                return;
            }
            
            const rows = data.page_stats.map(page => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800">
                    <td class="py-2 px-3 font-mono text-sm">${page.path}</td>
                    <td class="py-2 px-3 text-center">${page.views}</td>
                    <td class="py-2 px-3 text-center">${page.unique}</td>
                </tr>
            `).join('');
            
            tbody.innerHTML = rows;
        })
        .catch(error => console.error('Page stats error:', error));
}

// Region statistics
function updateRegionStats(siteName) {
    const tbody = document.getElementById('regionsTableBody');
    if (!tbody) return;
    
    if (!siteName) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-4">Select a site to view region statistics</td></tr>';
        return;
    }
    
    fetch(`/admin/api/site-analytics/${siteName}/regions`)
        .then(response => response.json())
        .then(data => {
            if (!data.region_stats || data.region_stats.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-4">No region data available</td></tr>';
                return;
            }
            
            const rows = data.region_stats.map(region => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800">
                    <td class="py-2 px-3">${region.region}</td>
                    <td class="py-2 px-3 text-center">${region.count}</td>
                    <td class="py-2 px-3 text-center">${region.percentage.toFixed(1)}%</td>
                </tr>
            `).join('');
            
            tbody.innerHTML = rows;
            
            // Update chart
            updateRegionChart(data.region_stats);
        })
        .catch(error => console.error('Region stats error:', error));
}

function updateRegionChart(regionStats) {
    const canvas = document.getElementById('regionsChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    if (charts.regions) {
        charts.regions.destroy();
    }
    
    charts.regions = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: regionStats.map(r => r.region),
            datasets: [{
                data: regionStats.map(r => r.count),
                backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        }
    });
}

// Export functionality
function exportSiteData(format) {
    const siteName = document.getElementById('exportSiteSelect')?.value;
    const period = document.getElementById('exportPeriodSelect')?.value || '30d';
    
    if (!siteName) {
        alert('Please select a site first');
        return;
    }
    
    const url = `/admin/api/site-analytics/${siteName}/export?period=${period}&format=${format}&download=true`;
    const link = document.createElement('a');
    link.href = url;
    link.download = `${siteName}-analytics-${period}.${format}`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Update charts with analytics data
function updateChartsWithData(data) {
    // Update active viewers chart
    if (charts.activeViewers && data.sites) {
        const activeData = Object.entries(data.sites)
            .filter(([_, site]) => site.active > 0)
            .map(([name, site]) => ({ name, active: site.active }));
        
        if (activeData.length > 0) {
            charts.activeViewers.data.labels = activeData.map(s => s.name);
            charts.activeViewers.data.datasets[0].data = activeData.map(s => s.active);
            charts.activeViewers.update();
        }
    }
    
    // Update weekly visitors chart
    if (charts.weeklyVisitors && data.sites) {
        const weeklyData = Object.entries(data.sites)
            .filter(([_, site]) => site.weekly > 0)
            .map(([name, site]) => ({ name, weekly: site.weekly }))
            .sort((a, b) => b.weekly - a.weekly)
            .slice(0, 10); // Top 10 sites
        
        if (weeklyData.length > 0) {
            charts.weeklyVisitors.data.labels = weeklyData.map(s => s.name);
            charts.weeklyVisitors.data.datasets[0].data = weeklyData.map(s => s.weekly);
            charts.weeklyVisitors.update();
        }
    }
}

// Real analytics data loading
function loadRealAnalyticsData() {
    fetch('/admin/api/site-analytics')
        .then(response => response.json())
        .then(data => {
            if (data) {
                // Update stats cards
                const activeViewersEl = document.getElementById('activeViewersCount');
                if (activeViewersEl) activeViewersEl.textContent = data.total_active || '0';
                
                const weeklyVisitorsEl = document.getElementById('weeklyVisitorsCount');
                if (weeklyVisitorsEl) weeklyVisitorsEl.textContent = data.total_weekly || '0';
                
                const activeSitesEl = document.getElementById('activeSitesCount');
                if (activeSitesEl) activeSitesEl.textContent = data.active_sites || '0';
                
                // Update charts
                updateChartsWithData(data);
                
                // Update site dropdowns for Phase 5 features
                updateSiteDropdowns();
            }
        })
        .catch(error => console.error('Error loading analytics:', error));
}

</script>
{{end}}