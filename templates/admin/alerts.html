{{define "content"}}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-6 text-white">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold mb-2">
                    <i class="fas fa-bell mr-3"></i>Alert Management
                </h1>
                <p class="text-blue-100 text-sm md:text-base">Monitor system alerts, configure notification rules, and manage alert channels</p>
            </div>
            <div class="mt-4 md:mt-0 flex flex-col sm:flex-row gap-2">
                <button onclick="triggerTestAlert()" class="btn btn-primary bg-white/20 hover:bg-white/30 text-white border-white/30">
                    <i class="fas fa-flask mr-2"></i>Test Alert
                </button>
                <button onclick="openManualAlertModal()" class="btn btn-primary bg-white/20 hover:bg-white/30 text-white border-white/30">
                    <i class="fas fa-plus mr-2"></i>Manual Alert
                </button>
            </div>
        </div>
    </div>

    <!-- Alert Statistics Overview -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="card bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 border-green-200 dark:border-green-700">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-600 dark:text-green-400 text-sm font-medium">Active Alerts</p>
                        <p class="text-2xl font-bold text-green-800 dark:text-green-200" id="active-alerts-count">{{.Stats.active_alerts}}</p>
                    </div>
                    <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-white text-lg"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 border-blue-200 dark:border-blue-700">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-600 dark:text-blue-400 text-sm font-medium">Alert Rules</p>
                        <p class="text-2xl font-bold text-blue-800 dark:text-blue-200">{{.Stats.enabled_rules}}/{{.Stats.total_rules}}</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-cog text-white text-lg"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 border-purple-200 dark:border-purple-700">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-600 dark:text-purple-400 text-sm font-medium">Notification Channels</p>
                        <p class="text-2xl font-bold text-purple-800 dark:text-purple-200">{{.Stats.enabled_channels}}</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-paper-plane text-white text-lg"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-gradient-to-br from-orange-50 to-orange-100 dark:from-orange-900/20 dark:to-orange-800/20 border-orange-200 dark:border-orange-700">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-orange-600 dark:text-orange-400 text-sm font-medium">Alert History</p>
                        <p class="text-2xl font-bold text-orange-800 dark:text-orange-200">{{.Stats.history_size}}</p>
                    </div>
                    <div class="w-12 h-12 bg-orange-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-history text-white text-lg"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs for Different Alert Sections -->
    <div class="card">
        <div class="card-header">
            <div class="flex flex-wrap gap-2 border-b border-gray-200 dark:border-gray-700">
                <button class="alert-tab active" data-tab="active">
                    <i class="fas fa-exclamation-circle mr-2"></i>Active Alerts
                </button>
                <button class="alert-tab" data-tab="rules">
                    <i class="fas fa-cog mr-2"></i>Alert Rules
                </button>
                <button class="alert-tab" data-tab="channels">
                    <i class="fas fa-paper-plane mr-2"></i>Notification Channels
                </button>
                <button class="alert-tab" data-tab="history">
                    <i class="fas fa-history mr-2"></i>Alert History
                </button>
            </div>
        </div>

        <div class="card-body">
            <!-- Active Alerts Tab -->
            <div id="active-tab" class="alert-tab-content active">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2 sm:mb-0">Active Alerts</h3>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <select id="severity-filter" class="filter-control text-sm">
                            <option value="">All Severities</option>
                            <option value="critical">Critical</option>
                            <option value="warning">Warning</option>
                            <option value="info">Info</option>
                        </select>
                        <button onclick="refreshActiveAlerts()" class="btn btn-secondary text-sm">
                            <i class="fas fa-sync-alt mr-1"></i>Refresh
                        </button>
                    </div>
                </div>

                <div id="active-alerts-container" class="space-y-4">
                    {{range .ActiveAlerts}}
                    <div class="alert-item {{.Severity}}" data-alert-id="{{.ID}}">
                        <div class="flex flex-col md:flex-row md:items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="alert-severity-badge {{.Severity}}">{{.Severity}}</span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400">{{.Component}}</span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400">{{.CreatedAt.Format "2006-01-02 15:04:05"}}</span>
                                </div>
                                <h4 class="font-semibold text-gray-900 dark:text-white mb-1">{{.Title}}</h4>
                                <p class="text-gray-600 dark:text-gray-300 text-sm">{{.Message}}</p>
                                {{if .AckedBy}}
                                <p class="text-xs text-blue-600 dark:text-blue-400 mt-2">
                                    <i class="fas fa-check mr-1"></i>Acknowledged by {{.AckedBy}} at {{.AckedAt.Format "15:04:05"}}
                                </p>
                                {{end}}
                            </div>
                            <div class="flex flex-col sm:flex-row gap-2 mt-3 md:mt-0 md:ml-4">
                                {{if eq .Status "active"}}
                                <button onclick="acknowledgeAlert('{{.ID}}')" class="btn btn-secondary text-sm">
                                    <i class="fas fa-check mr-1"></i>Acknowledge
                                </button>
                                {{end}}
                                <button onclick="resolveAlert('{{.ID}}')" class="btn btn-success text-sm">
                                    <i class="fas fa-times mr-1"></i>Resolve
                                </button>
                            </div>
                        </div>
                    </div>
                    {{else}}
                    <div class="text-center py-8">
                        <i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">No Active Alerts</h3>
                        <p class="text-gray-600 dark:text-gray-400">All systems are operating normally.</p>
                    </div>
                    {{end}}
                </div>
            </div>

            <!-- Alert Rules Tab -->
            <div id="rules-tab" class="alert-tab-content">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2 sm:mb-0">Alert Rules</h3>
                    <button onclick="openRuleModal()" class="btn btn-primary text-sm">
                        <i class="fas fa-plus mr-1"></i>Add Rule
                    </button>
                </div>

                <div class="space-y-4">
                    {{range .Rules}}
                    <div class="rule-item {{if .Enabled}}enabled{{else}}disabled{{end}}" data-rule-id="{{.ID}}">
                        <div class="flex flex-col lg:flex-row lg:items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="rule-status-badge {{if .Enabled}}enabled{{else}}disabled{{end}}">
                                        {{if .Enabled}}Enabled{{else}}Disabled{{end}}
                                    </span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400">{{.Component}}</span>
                                    <span class="alert-severity-badge {{.Severity}}">{{.Severity}}</span>
                                </div>
                                <h4 class="font-semibold text-gray-900 dark:text-white mb-1">{{.Name}}</h4>
                                <p class="text-gray-600 dark:text-gray-300 text-sm mb-2">{{.Description}}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">
                                    Metric: {{.Metric}} {{.Operator}} {{.Threshold}} for {{.Duration}}
                                </p>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-2 mt-3 lg:mt-0 lg:ml-4">
                                <button onclick="editRule('{{.ID}}')" class="btn btn-secondary text-sm">
                                    <i class="fas fa-edit mr-1"></i>Edit
                                </button>
                                <button onclick="toggleRule('{{.ID}}')" class="btn {{if .Enabled}}btn-warning{{else}}btn-success{{end}} text-sm">
                                    <i class="fas fa-{{if .Enabled}}pause{{else}}play{{end}} mr-1"></i>{{if .Enabled}}Disable{{else}}Enable{{end}}
                                </button>
                            </div>
                        </div>
                    </div>
                    {{end}}
                </div>
            </div>

            <!-- Notification Channels Tab -->
            <div id="channels-tab" class="alert-tab-content">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2 sm:mb-0">Notification Channels</h3>
                    <button onclick="openChannelModal()" class="btn btn-primary text-sm">
                        <i class="fas fa-plus mr-1"></i>Add Channel
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {{range .Channels}}
                    <div class="channel-item {{if .Enabled}}enabled{{else}}disabled{{end}}" data-channel-id="{{.ID}}">
                        <div class="card">
                            <div class="card-body">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-2">
                                        <i class="channel-icon {{if eq .Type "email"}}fas fa-envelope{{else if eq .Type "webhook"}}fas fa-link{{else if eq .Type "telegram"}}fab fa-telegram{{else}}fas fa-bell{{end}} text-lg"></i>
                                        <span class="channel-status-badge {{if .Enabled}}enabled{{else}}disabled{{end}}">
                                            {{if .Enabled}}Active{{else}}Inactive{{end}}
                                        </span>
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="testChannel('{{.ID}}')" class="btn btn-secondary text-xs px-2 py-1" title="Test Channel">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        <button onclick="editChannel('{{.ID}}')" class="btn btn-secondary text-xs px-2 py-1" title="Edit Channel">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                                <h4 class="font-semibold text-gray-900 dark:text-white mb-1">{{.Name}}</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">{{.Type}} Notifications</p>
                                {{if .TestMode}}
                                <span class="inline-block bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 text-xs px-2 py-1 rounded">Test Mode</span>
                                {{end}}
                            </div>
                        </div>
                    </div>
                    {{end}}
                </div>
            </div>

            <!-- Alert History Tab -->
            <div id="history-tab" class="alert-tab-content">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2 sm:mb-0">Alert History</h3>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <select id="history-limit" class="filter-control text-sm">
                            <option value="50">Last 50</option>
                            <option value="100">Last 100</option>
                            <option value="200">Last 200</option>
                        </select>
                        <button onclick="refreshHistory()" class="btn btn-secondary text-sm">
                            <i class="fas fa-sync-alt mr-1"></i>Refresh
                        </button>
                        <button onclick="exportHistory()" class="btn btn-secondary text-sm">
                            <i class="fas fa-download mr-1"></i>Export
                        </button>
                    </div>
                </div>

                <div id="history-container" class="space-y-2">
                    <!-- History items will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Manual Alert Modal -->
<div id="manual-alert-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Manual Alert</h3>
                <button onclick="closeManualAlertModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="manual-alert-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Title</label>
                    <input type="text" id="alert-title" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Message</label>
                    <textarea id="alert-message" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Component</label>
                    <select id="alert-component" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                        <option value="manual">Manual</option>
                        <option value="address_pool">Address Pool</option>
                        <option value="gap_monitor">Gap Monitor</option>
                        <option value="rate_limiter">Rate Limiter</option>
                        <option value="system">System</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Severity</label>
                    <select id="alert-severity" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                        <option value="info">Info</option>
                        <option value="warning">Warning</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 btn btn-primary">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Trigger Alert
                    </button>
                    <button type="button" onclick="closeManualAlertModal()" class="flex-1 btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Alert-specific styles */
.alert-tab {
    padding: 0.75rem 1rem;
    border-bottom: 2px solid transparent;
    color: var(--text-secondary);
    background: none;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    white-space: nowrap;
}

.alert-tab:hover {
    color: var(--text-primary);
    background: var(--bg-tertiary);
    border-radius: 0.5rem 0.5rem 0 0;
}

.alert-tab.active {
    color: var(--accent-blue);
    border-bottom-color: var(--accent-blue);
    background: var(--bg-tertiary);
}

.alert-tab-content {
    display: none;
}

.alert-tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease-in;
}

.alert-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.alert-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    transition: background-color 0.3s ease;
}

.alert-item.critical::before {
    background: linear-gradient(180deg, #ef4444, #dc2626);
}

.alert-item.warning::before {
    background: linear-gradient(180deg, #f59e0b, #d97706);
}

.alert-item.info::before {
    background: linear-gradient(180deg, #3b82f6, #1d4ed8);
}

.alert-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.alert-severity-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.alert-severity-badge.critical {
    background: linear-gradient(135deg, #fee2e2, #fecaca);
    color: #991b1b;
}

.alert-severity-badge.warning {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    color: #92400e;
}

.alert-severity-badge.info {
    background: linear-gradient(135deg, #dbeafe, #bfdbfe);
    color: #1e40af;
}

[data-theme="dark"] .alert-severity-badge.critical {
    background: linear-gradient(135deg, #7f1d1d, #991b1b);
    color: #fecaca;
}

[data-theme="dark"] .alert-severity-badge.warning {
    background: linear-gradient(135deg, #92400e, #b45309);
    color: #fde68a;
}

[data-theme="dark"] .alert-severity-badge.info {
    background: linear-gradient(135deg, #1e40af, #1d4ed8);
    color: #bfdbfe;
}

.rule-item, .channel-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1rem;
    transition: all 0.3s ease;
}

.rule-item:hover, .channel-item:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.rule-status-badge, .channel-status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.rule-status-badge.enabled, .channel-status-badge.enabled {
    background: linear-gradient(135deg, #d1fae5, #a7f3d0);
    color: #065f46;
}

.rule-status-badge.disabled, .channel-status-badge.disabled {
    background: linear-gradient(135deg, #fee2e2, #fecaca);
    color: #991b1b;
}

[data-theme="dark"] .rule-status-badge.enabled,
[data-theme="dark"] .channel-status-badge.enabled {
    background: linear-gradient(135deg, #065f46, #047857);
    color: #a7f3d0;
}

[data-theme="dark"] .rule-status-badge.disabled,
[data-theme="dark"] .channel-status-badge.disabled {
    background: linear-gradient(135deg, #7f1d1d, #991b1b);
    color: #fecaca;
}

.channel-icon {
    color: var(--accent-blue);
}

/* Responsive improvements */
@media (max-width: 768px) {
    .alert-tab {
        font-size: 0.8rem;
        padding: 0.5rem 0.75rem;
    }
    
    .alert-item, .rule-item {
        padding: 0.75rem;
    }
    
    .alert-severity-badge, .rule-status-badge, .channel-status-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
    }
}

@media (max-width: 480px) {
    .alert-tab {
        flex-direction: column;
        text-align: center;
        padding: 0.5rem;
    }
    
    .alert-tab i {
        margin-bottom: 0.25rem;
        margin-right: 0;
    }
}
</style>

<script>
// Alert management JavaScript
let currentTab = 'active';

// Tab switching
document.querySelectorAll('.alert-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        switchTab(tabName);
    });
});

function switchTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.alert-tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    
    // Update tab content
    document.querySelectorAll('.alert-tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById(`${tabName}-tab`).classList.add('active');
    
    currentTab = tabName;
    
    // Load content if needed
    if (tabName === 'history') {
        loadAlertHistory();
    }
}

// Alert actions
function acknowledgeAlert(alertId) {
    const ackedBy = prompt('Enter your name:');
    if (!ackedBy) return;
    
    fetch('/admin/api/alerts/acknowledge', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            alert_id: alertId,
            acked_by: ackedBy
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showNotification('error', data.error);
        } else {
            showNotification('success', 'Alert acknowledged successfully');
            refreshActiveAlerts();
        }
    })
    .catch(error => {
        showNotification('error', 'Failed to acknowledge alert');
        console.error('Error:', error);
    });
}

function resolveAlert(alertId) {
    if (!confirm('Are you sure you want to resolve this alert?')) return;
    
    fetch('/admin/api/alerts/resolve', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            alert_id: alertId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showNotification('error', data.error);
        } else {
            showNotification('success', 'Alert resolved successfully');
            refreshActiveAlerts();
        }
    })
    .catch(error => {
        showNotification('error', 'Failed to resolve alert');
        console.error('Error:', error);
    });
}

function triggerTestAlert() {
    fetch('/admin/api/alerts/trigger', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            title: 'Test Alert',
            message: 'This is a test alert triggered from the admin dashboard',
            component: 'admin_dashboard',
            severity: 'info',
            metadata: {
                test: true,
                triggered_at: new Date().toISOString()
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showNotification('error', data.error);
        } else {
            showNotification('success', 'Test alert triggered successfully');
            refreshActiveAlerts();
        }
    })
    .catch(error => {
        showNotification('error', 'Failed to trigger test alert');
        console.error('Error:', error);
    });
}

// Manual alert modal
function openManualAlertModal() {
    document.getElementById('manual-alert-modal').classList.remove('hidden');
}

function closeManualAlertModal() {
    document.getElementById('manual-alert-modal').classList.add('hidden');
    document.getElementById('manual-alert-form').reset();
}

document.getElementById('manual-alert-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        title: document.getElementById('alert-title').value,
        message: document.getElementById('alert-message').value,
        component: document.getElementById('alert-component').value,
        severity: document.getElementById('alert-severity').value
    };
    
    fetch('/admin/api/alerts/trigger', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showNotification('error', data.error);
        } else {
            showNotification('success', 'Alert triggered successfully');
            closeManualAlertModal();
            refreshActiveAlerts();
        }
    })
    .catch(error => {
        showNotification('error', 'Failed to trigger alert');
        console.error('Error:', error);
    });
});

// Channel testing
function testChannel(channelId) {
    fetch('/admin/api/alerts/test-channel', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            channel_id: channelId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showNotification('error', data.error);
        } else {
            showNotification('success', 'Test notification sent successfully');
        }
    })
    .catch(error => {
        showNotification('error', 'Failed to send test notification');
        console.error('Error:', error);
    });
}

// Refresh functions
function refreshActiveAlerts() {
    fetch('/admin/api/alerts/active')
    .then(response => response.json())
    .then(data => {
        // Update active alerts display
        updateActiveAlertsDisplay(data.alerts);
        updateStatsDisplay();
    })
    .catch(error => {
        console.error('Error refreshing alerts:', error);
    });
}

function refreshHistory() {
    loadAlertHistory();
}

function loadAlertHistory() {
    const limit = document.getElementById('history-limit').value;
    
    fetch(`/admin/api/alerts/history?limit=${limit}`)
    .then(response => response.json())
    .then(data => {
        updateHistoryDisplay(data.history);
    })
    .catch(error => {
        console.error('Error loading history:', error);
    });
}

function updateActiveAlertsDisplay(alerts) {
    const container = document.getElementById('active-alerts-container');
    
    if (alerts.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">No Active Alerts</h3>
                <p class="text-gray-600 dark:text-gray-400">All systems are operating normally.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = alerts.map(alert => `
        <div class="alert-item ${alert.severity}" data-alert-id="${alert.id}">
            <div class="flex flex-col md:flex-row md:items-center justify-between">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="alert-severity-badge ${alert.severity}">${alert.severity}</span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">${alert.component}</span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">${new Date(alert.created_at).toLocaleString()}</span>
                    </div>
                    <h4 class="font-semibold text-gray-900 dark:text-white mb-1">${alert.title}</h4>
                    <p class="text-gray-600 dark:text-gray-300 text-sm">${alert.message}</p>
                    ${alert.acked_by ? `
                        <p class="text-xs text-blue-600 dark:text-blue-400 mt-2">
                            <i class="fas fa-check mr-1"></i>Acknowledged by ${alert.acked_by} at ${new Date(alert.acked_at).toLocaleTimeString()}
                        </p>
                    ` : ''}
                </div>
                <div class="flex flex-col sm:flex-row gap-2 mt-3 md:mt-0 md:ml-4">
                    ${alert.status === 'active' ? `
                        <button onclick="acknowledgeAlert('${alert.id}')" class="btn btn-secondary text-sm">
                            <i class="fas fa-check mr-1"></i>Acknowledge
                        </button>
                    ` : ''}
                    <button onclick="resolveAlert('${alert.id}')" class="btn btn-success text-sm">
                        <i class="fas fa-times mr-1"></i>Resolve
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function updateHistoryDisplay(history) {
    const container = document.getElementById('history-container');
    
    if (!history || history.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-history text-gray-400 text-4xl mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">No Alert History</h3>
                <p class="text-gray-600 dark:text-gray-400">No historical alerts found.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = history.map(alert => `
        <div class="alert-item ${alert.severity}">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-1">
                        <span class="alert-severity-badge ${alert.severity}">${alert.severity}</span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">${alert.component}</span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">${new Date(alert.created_at).toLocaleString()}</span>
                    </div>
                    <h4 class="font-semibold text-gray-900 dark:text-white text-sm">${alert.title}</h4>
                    <p class="text-gray-600 dark:text-gray-300 text-xs">${alert.message}</p>
                </div>
                <div class="ml-4">
                    <span class="inline-block px-2 py-1 text-xs rounded-full ${
                        alert.status === 'resolved' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' :
                        alert.status === 'acknowledged' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' :
                        'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                    }">
                        ${alert.status}
                    </span>
                </div>
            </div>
        </div>
    `).join('');
}

function updateStatsDisplay() {
    fetch('/admin/api/alerts/stats')
    .then(response => response.json())
    .then(stats => {
        document.getElementById('active-alerts-count').textContent = stats.active_alerts || 0;
    })
    .catch(error => {
        console.error('Error updating stats:', error);
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Load initial data
    if (currentTab === 'history') {
        loadAlertHistory();
    }
    
    // Set up auto-refresh
    setInterval(() => {
        if (currentTab === 'active') {
            refreshActiveAlerts();
        }
    }, 30000); // Refresh every 30 seconds
    
    // Close modal when clicking outside
    document.getElementById('manual-alert-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeManualAlertModal();
        }
    });
});

// Placeholder functions for future implementation
function editRule(ruleId) {
    showNotification('info', 'Rule editing feature coming soon');
}

function toggleRule(ruleId) {
    showNotification('info', 'Rule toggle feature coming soon');
}

function openRuleModal() {
    showNotification('info', 'Add rule feature coming soon');
}

function editChannel(channelId) {
    showNotification('info', 'Channel editing feature coming soon');
}

function openChannelModal() {
    showNotification('info', 'Add channel feature coming soon');
}

function exportHistory() {
    showNotification('info', 'Export feature coming soon');
}
</script>
{{end}}